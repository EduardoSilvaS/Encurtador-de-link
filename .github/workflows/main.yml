name: Testes de Integração (Manual e Auto)

on:
  push:
    branches: [ "workflowTestGiovani"]
  pull_request:
    branches: [ "workflowTestGiovani"]
  # Permite executar manualmente na aba Actions do GitHub
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Preparação
    - name: Checkout do código
      uses: actions/checkout@v3

    - name: Subir ambiente com Docker Compose
      run: docker-compose -f docker-compose.test.yml up -d

    - name: Aguardar inicialização dos serviços
      run: sleep 15 # Tempo para o Postgres aceitar conexões

    - name: Verificar status dos containers
      run: docker-compose -f docker-compose.test.yml ps

    # --- TESTE 1: Disponibilidade do Proxy ---
    - name: '[Teste 1] Verificar se o Proxy está acessível'
      run: |
        echo "Tentando acessar a página inicial..."
        # O curl retorna o código HTTP. Esperamos 200 (OK) ou 404 (Not Found - mas servido pelo nginx)
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        
        if [[ "$HTTP_CODE" -eq 200 ]] || [[ "$HTTP_CODE" -eq 404 ]]; then
          echo "✅ SUCESSO: O Proxy respondeu com código $HTTP_CODE"
        else
          echo "❌ FALHA: O Proxy não respondeu corretamente. Código: $HTTP_CODE"
          exit 1
        fi

    # --- TESTE 2: Validação do Schema do Banco ---
    - name: '[Teste 2] Verificar se a tabela "links" foi criada'
      run: |
        # Executa um comando SQL dentro do container do banco para ver se a tabela existe
        TABLE_CHECK=$(docker-compose -f docker-compose.test.yml exec -T db psql -U postgres -d encurtador_db -c "\dt links")
        
        if [[ "$TABLE_CHECK" == *"links"* ]]; then
          echo "✅ SUCESSO: A tabela 'links' foi encontrada no banco de dados."
        else
          echo "❌ FALHA: A tabela 'links' não existe. O init.sql falhou?"
          echo "$TABLE_CHECK"
          exit 1
        fi

    # --- TESTE 3: Fluxo Completo (Inserir e Consultar) ---
    - name: '[Teste 3] Inserir link no Banco e acessar via Proxy'
      run: |
        # 1. Inserir um link de teste diretamente no banco
        echo "Inserindo link de teste..."
        docker-compose -f docker-compose.test.yml exec -T db psql -U postgres -d encurtador_db -c "INSERT INTO links (code, original_url) VALUES ('teste123', 'http://www.google.com');"
        
        # 2. Tentar acessar esse link através do Proxy (Simulando um usuário)
        # Se o sistema funcionar, o App vai ler do Banco e devolver o redirecionamento ou JSON
        echo "Acessando http://localhost:8080/teste123 ..."
        RESPONSE=$(curl -s -I http://localhost:8080/teste123)
        
        # Verificamos se a resposta contém referência ao Google ou um código de redirecionamento (301/302) ou sucesso (200)
        if echo "$RESPONSE" | grep -q "HTTP/1.1 3" || echo "$RESPONSE" | grep -q "200"; then
          echo "✅ SUCESSO: O sistema processou o link 'teste123'."
        else
          echo "❌ FALHA: Não foi possível recuperar o link inserido."
          echo "Resposta do servidor:"
          echo "$RESPONSE"
          exit 1
        fi

    # 4. Limpeza
    - name: Derrubar ambiente
      if: always()
      run: docker-compose -f docker-compose.test.yml down
